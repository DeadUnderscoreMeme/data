name: Commentary sepration

on:
  push:
    branches: [ master ]

jobs:
  transform:

    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.6]
#         python-version: [3.5, 3.6, 3.7, 3.8]

    steps:
    - uses: actions/checkout@master
      with:
        persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
        fetch-depth: 1 # Because of this, you will fail to push refs to dest repo
    - name: Checkout Processed files
      uses: actions/checkout@master
      with:
        repository: sanskrit/ashtadhyayi_com_transforms
        persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
        path: processed_data
        fetch-depth: 1 # Because of this, you will fail to push refs to dest repo
    - uses: lots0logs/gh-action-get-changed-files@2.1.4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install git+https://github.com/sanskrit-coders/doc_curation/@master -U
        python -m pip install git+https://github.com/ashtadhyayi/data_curation@master -U
    - name: Create local changes
      run: |
        echo Not running: rm -rf `pwd`/processed_data/*/
        cp ${HOME}/files*.json `pwd`/processed_data/change_details -nf
        cp ${GITHUB_EVENT_PATH} `pwd`/processed_data/change_details -nf
        python -c "from ashtadhyayi_data.reader.ashtadhyayi_com import transformer; transformer.transform(indir=\"`pwd`\", outdir=\"`pwd`/processed_data/\", dry_run=False)"
    - name: Commit changes
      env:
        TRANSFORM_REPO_TOKEN: ${{ secrets.VISH_TOKEN }}
        REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        printf "https://github.com/ashtadhyayi-com/data/actions/runs/$GITHUB_RUN_ID\nlast_commit_log: $(git log -1 --pretty=format:"%s")" > processed_data/change_details/current_run.md
        cd processed_data
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add --all
        git diff-index --quiet HEAD || git commit -m "Add changes" -a
        remote_repo="https://${GITHUB_ACTOR}:${TRANSFORM_REPO_TOKEN}@github.com/sanskrit/ashtadhyayi_com_transforms.git"
        git push "${remote_repo}"|| (cd .. && git commit --allow-empty -m "Dummy commit to trigger workflow rerun upon 'push race condition'." && git push "https://${GITHUB_ACTOR}:${REPO_TOKEN}@github.com/${GITHUB_REPOSITORY}.git") 
      # We want to ensure that there is some change in processed_data for every change in ashtadhyayi data - so that downstream listeners can hark to the corresponding trigger.
      # Race conditions (A push after the initial checkout above, triggered by successive pushes to this repo) happen. Ideally, we should be able to restart the workflow, but that is not possible currently as per https://github.community/t/is-it-possible-to-manually-force-an-action-workflow-to-be-re-run/2127/23 .
